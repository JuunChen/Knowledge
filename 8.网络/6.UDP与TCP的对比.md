### UDP和TCP的对比

| UDP                                                          | TCP                                             |
| ------------------------------------------------------------ | ----------------------------------------------- |
| User Datagram Protocol<br />用户数据报协议                   | Transmission Control Protocol<br />传输控制协议 |
| 无连接                                                       | 面向连接                                        |
| 支持一对一，一对多，多对一和多对多交互通信                   | 每一条TCP连接只能有两个端点，只能是一对一通信   |
| 对应用层交付的报文直接打包                                   | 面向字节流                                      |
| 尽最大努力交付，也就是不可靠；<br />不使用流量控制和拥塞控制 | 可靠传输，使用流量控制和拥塞控制                |
| 首部开销小，仅8字节                                          | 首部最小20字节，最大60字节                      |

#### 是否面向连接对比

"连接"指的是逻辑连接关系。

如图，加入两台互联的主机在传输层使用UDP协议进行通信。

<img src="https://raw.githubusercontent.com/JuunChen/Knowledge/master/ImageFolder/8-1-1.png" style="zoom:30%;" />

UDP在传输数据之前不需要建立连接，通信双方可随时发送数据，因此我们称UDP是无连接的。



再来看看TCP。

<img src="https://raw.githubusercontent.com/JuunChen/Knowledge/master/ImageFolder/8-1-2.png" style="zoom:30%;" />

假设这两台互联的主机在运输层使用TCP进行通信。

TCP在传输数据之前必须建立连接。然后基于已经建立好的TCP连接进行数据传输。数据传输结束之后还要释放连接。

#### 是否支持广播和多播对比

如图所示，4台使用UDP通信的主机连接在一台以太网交换机上。

<img src="https://raw.githubusercontent.com/JuunChen/Knowledge/master/ImageFolder/8-1-3.png" style="zoom:30%;" />

其中，某台主机可以给另一台主机**单播**发送UDP数据报。也可以给该网络的其它全部主机**广播**发送UDP数据报。还可以给该网络上的其它某些主机**多播**发送UDP数据报。

也就是说，UDP支持单播、广播和多播。



再看看TCP。

<img src="https://raw.githubusercontent.com/JuunChen/Knowledge/master/ImageFolder/8-1-4.png" style="zoom:30%;" />

4台使用TCP通信的主机，连接在一台以太网交换机上。

各主机间要进行基于TCP的通信，必须首先建立TCP连接。

连接建立好之后，我们可以认为，这两台主机之间有一条基于TCP连接的可信通道。

之后，这两台主机就可以**通过该信道相互传输**TCP报文段了。

很显然，每一条TCP连接只能有两个端点。之能是1对1通信，也就是TCP连接只能进行单播通信。

#### 对应用层报文的处理对比

使用UDP的情况。

<img src="https://raw.githubusercontent.com/JuunChen/Knowledge/master/ImageFolder/8-1-5.png" style="zoom:35%;" />

如图所示。

1. 发送方应用进程将应用层的报文交付给运输层的UDP
2. UDP直接给应用层报文添加一个UDP首部，使之成为UDP用户数据包，然后进行发送
3. 传递给接收方（为了简单起见，这里忽略了下面各层的处理）
4. 接收方收到UDP用户数据报后，去掉UDP首部，将应用层报文交付给接收方的应用进程

由此可见，UDP对应用层交下来的报文**既不合并、也不拆分**，而是**保留这些报文的边界**。也就是说，**UDP是面向报文**的。



再来看使用TCP的情况。

<img src="https://raw.githubusercontent.com/JuunChen/Knowledge/master/ImageFolder/8-1-6.png" style="zoom:35%;" />

1. 发送方的TCP把应用进程交下来的数据块仅仅看作是一连串的无结构的字节流

2. TCP并不知道所传下来的字节流的含义，仅将它们编号并存储在自己的发送缓存

3. TCP根据发送策略从发送缓存中提取一定数量的字节构建TCP报文段并发送

4. 接收方的TCP一方面从所接收到的TCP报文段当中取出数据载荷部分并存储到接收缓存

5. 另一方面将自己接收缓存当中的一些字节交付给应用进程


TCP不保证接收方应用进程所收到的数据块和发送方应用进程所发出的数据块具有对应大小的关系。

例如，发送方应用进程交给发送方的TCP共10个数据块，但接收方的TCP可能只用了4个数据块就把收到的字节流交付给了上层的应用进程。

但接收方应用进程收到的字节流必须和发送方应用进程发成的字节流完全一样。

当然，接收方的应用进程必须有能力识别收到的字节流，把它还原成有意义的应用层数据。

综上所述，**TCP是面向字节流的**。这正是TCP实现**可靠传输、流量控制、拥塞控制**的基础。

需要说明的是，为了突出示意图的要点，这里只画出了一个方向的数据流。在实际网络中，基于TCP连接的两端可以**同时进行TCP报文段的发送和接收**。也就是**全双工通信**。另外，图中各TCP报文段的数据部分只包含几个字节，实际当中一个TCP报文段包上千个字节是很常见的。

#### 是否提供可靠传输服务对比

如图所示，互联网上的两台主机使用UDP进行通信。

<img src="https://raw.githubusercontent.com/JuunChen/Knowledge/master/ImageFolder/8-1-7.png" style="zoom:40%;" />

我们知道，网际层中的IP协议向其上层提供的是无连接不可靠服务；当运输层使用UDP协议时，向其上层提供的也是无连接的不可靠传输服务。

- 发送方给接收方发送UDP数据报，如果传输过程中产生了误码，接收方的UDP可以通过该数据报首部中的校验和字段的值检查出产生误码的情况，但并不做处理；

- 发送发给接收方发送UDP用户数据报，如果该数据报被互联网中的某个路由器丢弃了，发送发UDP不做任何处理。

UDP向上提供的是**无连接不可靠服务**，因此对于UDP用户数据报出现的误码、丢失等问题，UDP并不关心。

基于UDP的特点，UDP适用于实时应用（IP电话、视频会议等）。



再来看看TCP的情况。

<img src="https://raw.githubusercontent.com/JuunChen/Knowledge/master/ImageFolder/8-1-8.png" style="zoom:40%;" />

网际层的IP协议向上层提供的是无连接不可靠服务，但只要运输层使用TCP协议就能向其上层提供可靠传输服务。

##### 正确传输

1. 发送方给接收方发送TCP报文段
2. 接收方TCP收到该报文段后，根据其首部中的校验和字段的值检查该报文段是否产生了误码
3. 如果没有产生误码则收下该报文段并给发送发回确认报文段。

##### 误码超时重发

1. 发送发给接收方发送TCP报文段
2. 该报文段在传输过程中产生了误码
3. 接收方TCP监测到该报文段误码后，丢弃该报文段，而不给发送方TCP发送确认报文段
4. TCP发送方对该报文段的超时重发
5. 接收方TCP正确收到重发的该报文段后，收下该报文段
6. 接收方给发送方发回确认报文段。

##### 丢包超时重发

1. 发送方给接收方发送TCP报文段
2. 如果该报文段被互联网中的某个路由器丢弃了
3. 导致发送方TCP对该报文段的超时重发
4. 接收方TCP正确收到重发的该报文段后，收下该报文段
5. 接收方给发送方发回确认报文段。

##### 确认丢失





由此可见，尽管网际层的IP协议向上层提供的是无连接的不可靠服务，会产生数据报的误码和丢失等情况，但是只要在运输层使用TCP协议，就可以在不可靠的网际层之上使用可靠传输协议向应用层提供可靠传输的服务。换句话说，不管发送发所发送的数据报在传输过程中遭遇了什么情况，例如误码、丢包，只要收发双方在运输层使用TCP协议，那么接收方最终都会正确收到该数据包。

由于使用TCP进行通信的双方是建立在TCP连接之上的，因此可以说TCP向上层提供的是**面向连接的可靠服务**。

TCP适用于要求可靠传输的应用，例如文件传输。



#### 首部开销对比

<img src="https://raw.githubusercontent.com/JuunChen/Knowledge/master/ImageFolder/8-1-9.png" style="zoom:40%;" />

TCP要实现可靠传输、拥塞控制、流量控制，其首部字段自然要比UDP的复杂的多。