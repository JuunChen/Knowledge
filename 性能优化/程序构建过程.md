###构建过程（Build）
构建过程包括：预处理、编译、汇编、静态链接。
#### 预处理
主要处理源码中以`#`开头的预编译指令。比如:  

- **#include:** 用 include 指令包含的文件递归替换到到该指令的位置。
- **#define:** 删除 #define，展开所有宏定义。
- 处理条件预编译指令，如：**#if**、**#ifdef** ...
- 保留所有的 **#pragma** 编译器指令。

还有其它的一些工作。比如：

- 删除注释
- 添加行号标记，以便显示错误信息

完成之后：

- C 语言的 .c 文件预处理后文件的扩展名为 .i。  
- C++ 的 .cpp 文件预处理后的文件的扩展名则为 .ii。


```
hello.c
#include<stdio.h>
int main(){
	printf("hello");
}

#使用 gcc -E 对 hello.c 进行预处理，并输出到 hello.i 文件
$ gcc -E hello.c -o hello.i
#查看预处理后 .i 文件的内容。可以查看到stdio.h的展开部分，以及我们所写的代码。
$ cat hello.i
```

#### 编译
分析预处理文件，并产生汇编代码文件，扩展名为 .s。  
主要包含了一系列的语法、词法、语义分析，以及优化。

```
$ gcc -S hello.i #会自动产生 hello.s 文件
$ ls
$ cat hello.s
```
```
	.section	__TEXT,__text,regular,pure_instructions
	.build_version macos, 10, 14	sdk_version 10, 14
	.globl	_main                   ## -- Begin function main
	.p2align	4, 0x90
_main:                                  ## @main
	.cfi_startproc
## %bb.0:
	pushq	%rbp
	.cfi_def_cfa_offset 16
	.cfi_offset %rbp, -16
	movq	%rsp, %rbp
	.cfi_def_cfa_register %rbp
	subq	$16, %rsp
	leaq	L_.str(%rip), %rdi
	movb	$0, %al
	callq	_printf
	xorl	%ecx, %ecx
	movl	%eax, -4(%rbp)          ## 4-byte Spill
	movl	%ecx, %eax
	addq	$16, %rsp
	popq	%rbp
	retq
	.cfi_endproc
                                        ## -- End function
	.section	__TEXT,__cstring,cstring_literals
L_.str:                                 ## @.str
	.asciz	"hello"


.subsections_via_symbols
```

#### 汇编
将编译后的汇编代码翻译成机器指令，产生目标文件。

```
$ gcc -c hello.s
$ ls
$ cat hello.o
```

#### 静态链接

把各模块组装成可执行文件。  
处理好各模块之间的相互引用，对**符号（Symbol）**进行**重定向**。  

比如一个经典的静态链接过程：  
programa.c 与 programb.c 分别产生了 pa.o 与 pb.o 文件，  
pa.o 与 pb.o 和**库（Library）**一起链接生成 a.out 可执行文件。

**符号：**指针。表示函数或者变量的起始地址。  
**库：**一组目标文件的包。常用的代码编译成目标文件后，打包存放。  
**重定向：**模块 A 使用了模块 B 中的变量 var。在编译的时候，编译器并不知道 var 的地址，等到链接的时候确定了 var 的地址，链接器去修正 var 的地址的这个过程。